RewriteEngine On

# Remove duplicate RewriteEngine and fix index.php redirect
RewriteRule ^index\.php$ / [R=301,L]

# Hide .php extensions
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^(.*)$ $1.php [L]

# ======= SECURITY HEADERS & PROTECTION =======

# Enable HSTS Header
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

# Additional Security Headers
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Block common attacks
RewriteCond %{QUERY_STRING} (eval\() [NC,OR]
RewriteCond %{QUERY_STRING} (base64_encode) [NC,OR]
RewriteCond %{QUERY_STRING} (javascript:) [NC,OR]
RewriteCond %{QUERY_STRING} (<script) [NC,OR]
RewriteCond %{QUERY_STRING} (document\.cookie) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block SQL injections
RewriteCond %{QUERY_STRING} (union.*select) [NC,OR]
RewriteCond %{QUERY_STRING} (insert.*into) [NC,OR]
RewriteCond %{QUERY_STRING} (drop.*table) [NC,OR]
RewriteCond %{QUERY_STRING} (update.*set) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block file inclusion attacks
RewriteCond %{QUERY_STRING} (\.\./|\.\.\\|\.\.%2f|\.\.%5c) [NC]
RewriteRule ^(.*)$ - [F,L]

# Disable server signature
ServerSignature Off

# Prevent clickjacking
Header always set X-Frame-Options "SAMEORIGIN"

# Prevent MIME type sniffing
Header always set X-Content-Type-Options "nosniff"

# Enable XSS protection
Header always set X-XSS-Protection "1; mode=block"
# Block direct access to recaptcha config files
<Files "recaptcha.php">
    Order Allow,Deny
    Deny from all
</Files>
# Protect sensitive files
<FilesMatch "\.(env|log|ini|conf|sql)$">
    Deny from all
</FilesMatch>

<FilesMatch "^\.">
    Deny from all
</FilesMatch>
# ======= ADDITIONAL PATH SECURITY PROTECTION =======

# Disable directory browsing
Options -Indexes

# Block access to common backup and temp files
<FilesMatch "\.(bak|backup|old|tmp|temp|log|sql|tar|gz|zip|rar)$">
    Deny from all
</FilesMatch>

# Block access to version control files and directories
<FilesMatch "^\.git|\.svn|\.hg">
    Deny from all
</FilesMatch>

<DirectoryMatch "^\.git|\.svn|\.hg">
    Deny from all
</DirectoryMatch>

# Block access to common CMS/framework directories
<DirectoryMatch "(wp-admin|wp-includes|admin|config|configuration|includes|classes|modules|plugins|components|libraries|vendor)">
    Deny from all
</DirectoryMatch>

# Block access to configuration files
<FilesMatch "(config|configuration|wp-config|settings|database|db)\.(php|ini|conf|cfg)$">
    Deny from all
</FilesMatch>

# Block access to error and debug files
<FilesMatch "(error|debug|trace)\.(log|txt|php)$">
    Deny from all
</FilesMatch>

# Block common reconnaissance patterns
RewriteCond %{REQUEST_URI} (\.\.|%2e%2e|%2e\.) [NC,OR]
RewriteCond %{REQUEST_URI} (admin|config|configuration|backup|database|install|setup|test) [NC,OR]
RewriteCond %{REQUEST_URI} (\.(php|asp|aspx|cgi|pl|py|jsp|rb)$) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block access to sensitive files with specific patterns
RewriteCond %{REQUEST_URI} (passwd|shadow|hosts|htaccess|htpasswd) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block suspicious user agents
RewriteCond %{HTTP_USER_AGENT} (nmap|nikto|wikto|sf|sqlmap|bsqlbf|w3af|acunetix|burp|hydra|openvas|netsparker) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block requests without common headers (indicative of bots/scanners)
RewriteCond %{REQUEST_METHOD} ^(POST|PUT) [NC]
RewriteCond %{HTTP_REFERER} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} ^$ RewriteRule ^(.*)$ - [F,L]

# Block requests with suspicious patterns in the URI
RewriteCond %{REQUEST_URI} (\?|&|=|%|_|\$|\\|\.\.) [NC]
RewriteCond %{REQUEST_URI} (eval|exec|system|passthru|shell_exec|phpinfo|base64_decode) [NC]
RewriteRule ^(.*)$ - [F,L]