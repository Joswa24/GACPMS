

# Remove duplicate RewriteEngine and fix index.php redirect
RewriteRule ^index\.php$ / [R=301,L]

#   Hide .php extensions
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^(.*)$ $1.php [L]

# Block direct access to specific directories
RewriteRule ^admin/img/ - [F,L,NC]
RewriteRule ^admin/admin/uploads - [F,L,NC]
RewriteRule ^admin/uploads/ - [F,L,NC]

# ==========================================================
# Remove .php Extension from URLs
# ==========================================================

# Enable Apache's URL rewriting engine
RewriteEngine On

# Set the base path for all rewrite rules
# This assumes the .htaccess file is in the /instructor directory
RewriteBase /instructor/

# ----------------------------------------------------------
# Rule 1: Internal rewrite to add .php extension
# ----------------------------------------------------------
# Conditions for this rule:
# - The requested filename is not an existing file (!-f)
# - The requested filename is not an existing directory (!-d)
# - A file with the same name plus .php extension exists (.php -f)
# Action: Internally rewrite to the .php file
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.+)$ $1.php [L,QSA]

# ----------------------------------------------------------
# Rule 2: External redirect from .php to clean URLs
# ----------------------------------------------------------
# This redirects users who access .php files directly to the clean URL
# Example: domain.com/instructor/login.php → domain.com/instructor/login
# Conditions:
# - The request contains a .php file (THE_REQUEST checks the full request line)
# Action: 301 permanent redirect to the URL without .php
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s([^.]+)\.php [NC]
RewriteRule ^ %1 [R=301,L,NE]

# ----------------------------------------------------------
# Rule 3: Handle trailing slashes
# ----------------------------------------------------------
# Remove trailing slash if it's not a directory
# Example: domain.com/instructor/login/ → domain.com/instructor/login
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /instructor/$1 [R=301,L]

# ----------------------------------------------------------
# Optional: Add trailing slash to directories
# Uncomment if you want URLs to always end with /
# ----------------------------------------------------------
# RewriteCond %{REQUEST_FILENAME} -d
# RewriteRule ^(.*[^/])$ /instructor/$1/ [R=301,L]

# ----------------------------------------------------------
# Optional: Prevent direct access to .php files
# Uncomment for additional security
# ----------------------------------------------------------
# RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s(.+)\.php [NC]
# RewriteRule ^ - [F]

# ----------------------------------------------------------
# Custom Error Pages
# ----------------------------------------------------------
# Create 404.php and 403.php files in your instructor directory
ErrorDocument 404 /instructor/404.php
ErrorDocument 403 /instructor/403.php


# ======= SECURITY HEADERS & PROTECTION =======

# Enable HSTS Header
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

# Additional Security Headers
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Block common attacks
RewriteCond %{QUERY_STRING} (eval\() [NC,OR]
RewriteCond %{QUERY_STRING} (base64_encode) [NC,OR]
RewriteCond %{QUERY_STRING} (javascript:) [NC,OR]
RewriteCond %{QUERY_STRING} (<script) [NC,OR]
RewriteCond %{QUERY_STRING} (document\.cookie) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block SQL injections
RewriteCond %{QUERY_STRING} (union.*select) [NC,OR]
RewriteCond %{QUERY_STRING} (insert.*into) [NC,OR]
RewriteCond %{QUERY_STRING} (drop.*table) [NC,OR]
RewriteCond %{QUERY_STRING} (update.*set) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block file inclusion attacks
RewriteCond %{QUERY_STRING} (\.\./|\.\.\\|\.\.%2f|\.\.%5c) [NC]
RewriteRule ^(.*)$ - [F,L]

# Disable server signature
ServerSignature Off

# Prevent clickjacking
Header always set X-Frame-Options "SAMEORIGIN"

# Prevent MIME type sniffing
Header always set X-Content-Type-Options "nosniff"

# Enable XSS protection
Header always set X-XSS-Protection "1; mode=block"

# Block direct access to recaptcha config files
<Files "recaptcha.php">
    Order Allow,Deny
    Deny from all
</Files>

# Protect sensitive files
<FilesMatch "\.(env|log|ini|conf|sql)$">
    Deny from all
</FilesMatch>

<FilesMatch "^\.">
    Deny from all
</FilesMatch>

# Additional directory protection with .htaccess files
# This is an alternative method you can use if the RewriteRules above don't work as expected
# You would need to create a separate .htaccess file in each directory with:
# Deny from all